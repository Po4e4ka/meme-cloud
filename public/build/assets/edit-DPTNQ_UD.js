import{u as oe,r as a,j as t,H as ce}from"./app-BF_kn-ym.js";import{A as de}from"./app-layout-C8zvLXCL.js";import{I as ue}from"./index-DaM4CIyX.js";import{A as me,C as pe}from"./index.module-BwnKrlfv.js";import{C as fe}from"./check-DhW9V80U.js";/* empty css            */import"./createLucideIcon-BMdiHI2n.js";import"./index-CzW68mm-.js";import"./index-8p8MivbY.js";const ge=[{title:"Редактировать мемчик",href:""}],xe=[{Icon:me,target_url:"/",isActive:!1}];function Pe(){const{meme:r}=oe().props,[N,z]=a.useState(r.title??""),[E,_]=a.useState(""),[m,P]=a.useState(r.tags??[]),o=r.type==="video",u=a.useRef(null),g=a.useRef(!1),c=198,d=258,x=c/d,[B,Z]=a.useState({x:0,y:0}),[I,S]=a.useState(1),[p,K]=a.useState(null),[v,h]=a.useState(!1),[T,k]=a.useState(r.preview_url),[ve,H]=a.useState(null),[M,$]=a.useState(0),[V,q]=a.useState(0),[A,G]=a.useState(!1),[D,J]=a.useState(r.preview_url),[L,O]=a.useState(null),[w,Q]=a.useState(!r.preview_url);a.useEffect(()=>{g.current=!0},[]);function X(e){return/^[A-Za-zА-Яа-я0-9 ]+$/.test(e)&&!/ {3,}/.test(e)}function Y(e){if(e.key==="Enter"){e.preventDefault();const s=E.trim();if(!s)return;if(!X(s)){alert("Тег может содержать только буквы, цифры и максимум два пробела подряд.");return}m.includes(s)||P([...m,s]),_("")}}function ee(e){P(m.filter(s=>s!==e))}const te=a.useCallback((e,s)=>{K(s)},[]),F=a.useCallback(e=>new Promise((s,l)=>{const n=new Image;n.addEventListener("load",()=>s(n)),n.addEventListener("error",l),n.src=e}),[]),b=a.useCallback(async(e,s)=>{const l=await F(e),n=document.createElement("canvas");n.width=c,n.height=d;const i=n.getContext("2d");if(!i)throw new Error("Canvas context missing");return i.drawImage(l,s.x,s.y,s.width,s.height,0,0,c,d),n},[d,c,F]);a.useEffect(()=>{if(o||!p||!v&&r.preview_url)return;let e=!1;return b(r.media_url,p).then(async s=>{if(e)return;const l=s.toDataURL("image/jpeg",.9),n=await new Promise(i=>{s.toBlob(f=>i(f),"image/jpeg",.9)});n&&(k(l),H(new File([n],"preview.jpg",{type:"image/jpeg"})))}).catch(()=>{e||(k(null),H(null))}),()=>{e=!0}},[p,b,v,o,r.media_url,r.preview_url]);const j=a.useCallback(async()=>{if(!u.current)return null;const e=u.current,s=document.createElement("canvas");s.width=c,s.height=d;const l=s.getContext("2d");if(!l)return null;const n=e.videoWidth/e.videoHeight,i=x;let f=0,R=0,y=e.videoWidth,C=e.videoHeight;n>i?(y=e.videoHeight*i,f=(e.videoWidth-y)/2):n<i&&(C=e.videoWidth/i,R=(e.videoHeight-C)/2),l.drawImage(e,f,R,y,C,0,0,c,d);const W=await new Promise(le=>{s.toBlob(ie=>le(ie),"image/jpeg",.9)});if(!W)return null;const U=new File([W],"preview.jpg",{type:"image/jpeg"}),ne=s.toDataURL("image/jpeg",.9);return O(U),J(ne),U},[x,d,c]);a.useEffect(()=>{if(!o||!r.media_url)return;const e=u.current;if(!e)return;const s=()=>{$(e.duration),r.preview_url||(e.currentTime=0)},l=()=>{!w&&!A||j().finally(()=>{w&&Q(!1)})};return e.addEventListener("loadedmetadata",s),e.addEventListener("seeked",l),()=>{e.removeEventListener("loadedmetadata",s),e.removeEventListener("seeked",l)}},[j,A,o,r.media_url,r.preview_url,w]);const se=e=>{u.current&&(G(!0),q(e),u.current.currentTime=e)},ae=async()=>{if(o)return L||(r.preview_url?null:await j());if(!v&&r.preview_url||!p)return null;const e=await b(r.media_url,p),s=await new Promise(l=>{e.toBlob(n=>l(n),"image/jpeg",.9)});return s?new File([s],"preview.jpg",{type:"image/jpeg"}):null};function re(e){e.preventDefault();const s=new FormData;s.append("name",N),m.forEach((n,i)=>{s.append(`tags[${i}]`,n)});const l=new ue().v1().meme();ae().then(n=>{n&&s.append("preview",n),l.update(r.id,s)}).catch(()=>{alert("Не удалось подготовить превью")})}return t.jsxs(de,{breadcrumbs:ge,actions:xe,children:[t.jsx(ce,{title:"Редактировать мем"}),t.jsx("div",{className:"w-full p-6",children:t.jsxs("div",{className:"w-full rounded-2xl border border-slate-800 bg-slate-950/80 p-6 shadow-xl",children:[t.jsx("h1",{className:"text-2xl font-bold text-slate-100 mb-6",children:"Редактировать мем"}),t.jsx("form",{onSubmit:re,className:"text-slate-100",children:t.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-[1.1fr_0.9fr]",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block font-medium mb-2 text-slate-200",children:"Файл"}),t.jsx("div",{className:"rounded-xl border border-slate-800 bg-slate-900/70 p-4",children:o?t.jsx("video",{ref:u,src:r.media_url,className:"rounded-xl max-h-64 object-contain w-full bg-slate-900/70",controls:!0}):t.jsx("img",{src:r.media_url,alt:r.title,className:"rounded-xl max-h-64 object-contain w-full bg-slate-900/70"})})]}),t.jsxs("div",{className:"mt-2 space-y-3",children:[t.jsx("p",{className:"font-medium text-slate-200",children:"Превью 9:16"}),o?t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{type:"range",min:0,max:Math.max(0,M),step:.1,value:V,onChange:e=>se(Number(e.target.value)),className:"w-full"}),t.jsxs("span",{className:"text-xs text-slate-400 w-12 text-right",children:[V.toFixed(1),"s"]})]}),D&&t.jsx("img",{src:D,alt:"preview",className:"rounded-xl max-h-64 object-contain border border-slate-800 w-full bg-slate-900/70"})]}):t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"relative h-80 w-full overflow-hidden rounded-xl border border-slate-800 bg-slate-900/70",children:t.jsx(pe,{image:r.media_url,crop:B,zoom:I,aspect:x,onCropChange:e=>{Z(e),g.current&&h(!0)},onZoomChange:e=>{S(e),g.current&&h(!0)},onCropComplete:te})}),t.jsx("input",{type:"range",min:1,max:3,step:.05,value:I,onChange:e=>{S(Number(e.target.value)),h(!0)},className:"w-full"}),T&&t.jsx("img",{src:T,alt:"preview",className:"rounded-xl max-h-64 object-contain border border-slate-800 w-full bg-slate-900/70"})]})]})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block font-medium mb-1 text-slate-200",children:"Название"}),t.jsx("input",{value:N,onChange:e=>z(e.target.value),className:"border border-slate-800 rounded-lg px-3 py-2 w-full bg-slate-900/80 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/60",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block font-medium mb-1 text-slate-200",children:"Теги"}),t.jsx("input",{type:"text",value:E,onChange:e=>_(e.target.value),onKeyDown:Y,placeholder:"Введите тег и нажмите Enter",className:"border border-slate-800 rounded-lg px-3 py-2 w-full bg-slate-900/80 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/60"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:m.map(e=>t.jsxs("span",{className:"px-2 py-1 bg-emerald-500/15 text-emerald-200 border border-emerald-500/40 rounded-full flex items-center gap-1 text-sm",children:[e,t.jsx("button",{type:"button",className:"text-rose-300 hover:text-rose-200",onClick:()=>ee(e),children:"×"})]},e))})]}),t.jsx("div",{className:"flex justify-center pt-2",children:t.jsxs("button",{type:"submit",className:"flex items-center gap-2 bg-cyan-500 text-slate-900 rounded-lg px-6 py-2.5 font-semibold hover:bg-cyan-400 transition",children:[t.jsx(fe,{size:18}),"Сохранить"]})})]})]})})]})})]})}export{Pe as default};
